<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel Multiverse RPG Character Sheet</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="page">
        <div class="header">
            <h1>Marvel Multiverse Character Sheet</h1>
        </div>

        <table>
            <tr>
                <th>Name</th>
                <th>Rank</th>
                <th>Karma</th>
            </tr>
            <tr>
                <td><input type="text" id="characterName" placeholder="Codename"></td>
                <td><input type="number" id="rank" placeholder="1 to 6" min="1" max="6" value=""></td>
                <td><input type="number" id="karma" placeholder="Rank" class="calculated"></td>
            </tr>
        </table>

        <div class="two-column">
            <div>
                <table>
                    <tr>
                        <th>Health</th>
                        <td><input type="number" id="health" placeholder="Resilience * 30" class="calculated"></td>
                    </tr>
                </table>
            </div>
            <div>
                <table>
                    <tr>
                        <th>Focus</th>
                        <td><input type="number" id="focus" placeholder="Vigilance * 30" class="calculated"></td>
                    </tr>
                </table>
            </div>
        </div>

        <table>
            <tr>
                <th>Size</th>
                <th>Run</th>
                <th>Climb</th>
                <th>Swim</th>
                <th>Jump</th>
                <th><input type="text" id="otherMovement" style="background-color: #f0f0f0; font-weight: bold"></td>
                <th>Initiative Modifier</th>
            </tr>
            <tr>
                <td><select id="size" name="size">
                    <option value="Average">Average</option>
                    <option value="Big">Big</option>
                    <option value="Small">Small</option>
                </select></td>
                <td><input type="number" id="run" class="calculated"></td>
                <td><input type="number" id="climb" class="calculated"></td>
                <td><input type="number" id="swim" class="calculated"></td>
                <td><input type="number" id="jump" class="calculated"></td>
                <td><input type="number" id="other"></td>
                <td><input type="text" id="initiativeModifier" placeholder="Vigilance" class="calculated"></td>
            </tr>
        </table>

        <div class="section-title">Abilities</div>
        <table class="abilities-table">
            <tr><th>Ability</th><th>Score</th><th>Defense</th><th>Non-Combat</th><th></th></tr>
            <tr>
                <td>Melee</td>
                <td><input type="number" id="meleeScore" placeholder="-3 to 9" min="-3" max="9" value=""></td>
                <td><input type="number" id="meleeDefense" placeholder="+10" class="calculated"></td>
                <td><input type="text" id="meleeNonCombat" placeholder="Score" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="melee">Roll</button></td>
            </tr>
            <tr>
                <td>Agility</td>
                <td><input type="number" id="agilityScore" placeholder="-3 to 9" min="-3" max="9" value=""></td>
                <td><input type="number" id="agilityDefense" placeholder="+10" class="calculated"></td>
                <td><input type="text" id="agilityNonCombat" placeholder="Score" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="agility">Roll</button></td>
            </tr>
            <tr>
                <td>Resilience</td>
                <td><input type="number" id="resilienceScore" placeholder="-3 to 9" min="-3" max="9" value=""></td>
                <td><input type="number" id="resilienceDefense" placeholder="+10" class="calculated"></td>
                <td><input type="text" id="resilienceNonCombat" placeholder="Score" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="resilience">Roll</button></td>
            </tr>
            <tr>
                <td>Vigilance</td>
                <td><input type="number" id="vigilanceScore" placeholder="-3 to 9" min="-3" max="9" value=""></td>
                <td><input type="number" id="vigilanceDefense" placeholder="+10" class="calculated"></td>
                <td><input type="text" id="vigilanceNonCombat" placeholder="Score" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="vigilance">Roll</button></td>
            </tr>
            <tr>
                <td>Ego</td>
                <td><input type="number" id="egoScore" placeholder="-3 to 9" min="-3" max="9" value=""></td>
                <td><input type="number" id="egoDefense" placeholder="+10" class="calculated"></td>
                <td><input type="text" id="egoNonCombat" placeholder="Score" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="ego">Roll</button></td>
            </tr>
            <tr>
                <td>Logic</td>
                <td><input type="number" id="logicScore" placeholder="-3 to 9" min="-3" max="9" value=""></td>
                <td><input type="number" id="logicDefense" placeholder="+10" class="calculated"></td>
                <td><input type="text" id="logicNonCombat" placeholder="Score" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="logic">Roll</button></td>
            </tr>
        </table>

        <div class="section-title">Damage</div>
        <table class="damage-table">
            <tr><th>Damage</th><th>Multiplier</th><th></th><th>Ability</th><th></th></tr>
            <tr>
                <td>Melee</td>
                <td><input type="number" id="meleeDamageMultiplier" placeholder="Rank" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="meleeDamageAbility" placeholder="Score" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="melee">Roll</button></td>
            </tr>
            <tr>
                <td>Agility</td>
                <td><input type="number" id="agilityDamageMultiplier" placeholder="Rank" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="agilityDamageAbility" placeholder="Score" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="agility">Roll</button></td>
            </tr>
            <tr>
                <td>Ego</td>
                <td><input type="number" id="egoDamageMultiplier" placeholder="Rank" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="egoDamageAbility" placeholder="Score" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="ego">Roll</button></td>
            </tr>
            <tr>
                <td>Logic</td>
                <td><input type="number" id="logicDamageMultiplier" placeholder="Rank" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="logicDamageAbility" placeholder="Score" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="logic">Roll</button></td>
            </tr>
        </table>
    </div>


    <div class="page">

        <!-- Traits Section -->
        <div class="section-title">Traits</div>
        <table id="traitsTable" class="traits-table">
            <colgroup>
                <col class="trait-name">
                <col class="trait-description">
            </colgroup>
            <thead>
                <tr><th>Trait</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
                <tr><td><input type="text" name="trait-name[]"></td><td><input type="text" name="trait-description[]"></td></tr>
            </tbody>
        </table>

        <!-- Tags Section -->
        <div class="section-title">Tags</div>
        <textarea id="tags" placeholder="Enter tags here"></textarea>
    </div>

    <div class="page">

        <!-- Powers Section -->
        <div class="section-title">Powers</div>
        <table id="powersTable" class="powers-table">
            <colgroup><col class="power-name"><col class="power-set"><col class="power-cost"><col class="power-duration"><col class="power-action"></colgroup>
            <thead><tr><th>Power</th><th>Set</th><th>Cost</th><th>Duration</th><th>Action</th></tr></thead>
            <tbody>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
                <tr><td><input type="text" name="power-name[]"></td><td><input type="text" name="power-set[]"></td><td><input type="text" name="power-cost[]"></td><td><input type="text" name="power-duration[]"></td><td><input type="text" name="power-action[]"></td></tr>
            </tbody>
        </table>
    </div>
</div>
<div class="page">

    <!-- Team Maneuver Section -->
    <div class="section-title">Team Maneuver</div>
    <table>
        <tr><th>Type</th><th>Selected</th><th>Level</th><th>Cost</th></tr>
        <tr><td>Offensive</td><td><input type="checkbox" name="teamManeuver" value="offensive"></td><td><input type="number" name="offensiveLevel"></td><td><input type="number" name="offensiveCost"></td></tr>
        <tr><td>Defensive</td><td><input type="checkbox" name="teamManeuver" value="defensive"></td><td><input type="number" name="defensiveLevel"></td><td><input type="number" name="defensiveCost"></td></tr>
        <tr><td>Rally</td><td><input type="checkbox" name="teamManeuver" value="rally"></td><td><input type="number" name="rallyLevel"></td><td><input type="number" name="rallyCost"></td></tr>
    </table>

    <!-- Character Details Section -->
    <div class="section-title">Character Details</div>
    <table class="character-details-table">
        <tr>
            <th>Real Name</th>
            <td><input type="text" id="realName" name="realName"></td>
            <th>Height</th>
            <td><input type="text" id="height" name="height"></td>
        </tr>
        <tr>
            <th>Weight</th>
            <td><input type="text" id="weight" name="weight"></td>
            <th>Gender</th>
            <td><input type="text" id="gender" name="gender"></td>
        </tr>
        <tr>
            <th>Eyes</th>
            <td><input type="text" id="eyes" name="eyes"></td>
            <th>Hair</th>
            <td><input type="text" id="hair" name="hair"></td>
        </tr>
        <tr>
            <th>Origin</th>
            <td><input type="text" id="origin" name="origin"></td>
        </tr>
        <tr>
            <th>Distinguishing Features</th>
            <td colspan="3"><input type="text" id="distinguishingFeatures" name="distinguishingFeatures"></td>
        </tr>
        <tr>
            <th>Team</th>
            <td><input type="text" id="team" name="team"></td>
            <th>Base</th>
            <td><input type="text" id="base" name="base"></td>
        </tr>
        <tr>
            <th>Occupation</th>
            <td colspan="3"><input type="text" id="occupation" name="occupation"></td>
        </tr>
    </table>
</div>

<!-- Power Descriptions Section -->
<div class="page">
    <div class="section-title">Power Descriptions (Page 1)</div>
    <textarea id="powerDescriptions" class ="powerDescriptions" style="height: 250mm;"></textarea>
</div>

<div class="page">
    <div class="section-title">Power Descriptions (Page 2)</div>
    <textarea id="powerDescriptions2" class ="powerDescriptions" style="height: 250mm;"></textarea>
</div>

<div class="page">
    <div class="section-title">Power Descriptions (Page 3) </div>
    <textarea id="powerDescriptions3" class ="powerDescriptions" style="height: 250mm;"></textarea>
</div>


<!-- Portrait Section -->
<div class="page">
  <div class="section-title">Portrait</div>
  <div class="portrait-container">
      <input type="text" id="portraitInput" placeholder="Enter URL or filename from 'portrait' directory">
      <div id="portraitDisplay" style="height: 180mm;"> </div>
  </div>
</div>

<!-- Notes Section -->
<div class="page">
    <div class="section-title">Notes</div>
    <textarea id="notes" style="height: 60mm;"></textarea>
</div>

<!-- Extra Page -->
<div class="page"></div>

<!-- Dice Roller Section -->

<div class="dice-roller">
    <div id="diceContainer" class="dice-container">
        <div class="die-group">
            <div class="die-pair">
                <div class="die-column">
                    <div id="die1" class="die die-white">1</div>
                </div>
                <div class="die-column">
                    <div id="rerollIndicator1" class="reroll-indicator"></div>
                    <div id="die1reroll" class="die die-white" style="visibility: hidden;">1</div>
                </div>
            </div>
            <div class="edge-trouble-buttons">
                <button class="edge-button" onclick="rollEdge(1)">Edge</button>
                <button class="trouble-button" onclick="rollTrouble(1)">Trouble</button>
            </div>
        </div>
        <div class="die-group">
            <div class="fantastic-indicator" id="fantasticIndicator">Fantastic!</div>
            <div class="ultimate-fantastic-indicator" id="ultimateFantasticIndicator">Ultimate Fantastic!</div>
            <div class="die-pair">
                <div class="die-column">
                    <div id="die2" class="die die-red">1</div>
                </div>
                <div class="die-column">
                    <div id="rerollIndicator2" class="reroll-indicator"></div>
                    <div id="die2reroll" class="die die-red" style="visibility: hidden;">1</div>
                </div>
            </div>
            <div class="edge-trouble-buttons">
                <button class="edge-button" onclick="rollEdge(2)">Edge</button>
                <button class="trouble-button" onclick="rollTrouble(2)">Trouble</button>
            </div>
        </div>
        <div class="die-group">
            <div class="die-pair">
                <div class="die-column">
                    <div id="die3" class="die die-white">1</div>
                </div>
                <div class="die-column">
                    <div id="rerollIndicator3" class="reroll-indicator"></div>
                    <div id="die3reroll" class="die die-white" style="visibility: hidden;">1</div>
                </div>
            </div>
            <div class="edge-trouble-buttons">
                <button class="edge-button" onclick="rollEdge(3)">Edge</button>
                <button class="trouble-button" onclick="rollTrouble(3)">Trouble</button>
            </div>
        </div>
    </div>
    <button id="rollAllButton">Roll 3d6</button>
    <div id="rollResult"></div>

    <!-- Save/Load Functions -->
    <div class="character-actions">
        <button id="saveCharacter">Save Character</button>
        <button id="loadCharacter">Load Character</button>
        <input type="file" id="fileInput" style="display: none;" accept=".json">
        <button id="newCharacter">New Character</button>
    </div>
</div>

<!-- Character Sheet Load and Save -->
<script>
    // Wait for the DOM to be fully loaded before executing the script
    document.addEventListener('DOMContentLoaded', function() {
    // Get references to the buttons and file input
        const saveButton = document.getElementById('saveCharacter');
        const loadButton = document.getElementById('loadCharacter');
        const newButton = document.getElementById('newCharacter');
        const fileInput = document.getElementById('fileInput');

    // Add event listeners to the buttons
        saveButton.addEventListener('click', saveCharacter);
    loadButton.addEventListener('click', () => fileInput.click()); // Trigger file input when load button is clicked
    newButton.addEventListener('click', newCharacter);
    fileInput.addEventListener('change', loadCharacter);

    // Function to save the character data
    function saveCharacter() {
        const characterData = {
            name: document.getElementById('characterName').value,
            rank: parseInt(document.getElementById('rank').value) || 1,
            karma: parseInt(document.getElementById('karma').value) || 0,
            health: parseInt(document.getElementById('health').value) || 0,
            focus: parseInt(document.getElementById('focus').value) || 0,
            initiative: document.getElementById('initiativeModifier').value,
            size: document.getElementById('size').value,
            speed: {
                run: parseInt(document.getElementById('run').value) || 0,
                climb: parseInt(document.getElementById('climb').value) || 0,
                swim: parseInt(document.getElementById('swim').value) || 0,
                jump: parseInt(document.getElementById('jump').value) || 0
            },
            abilities: {},
            damage: {},
            traits: [],
            tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()),
            powers: [],
            powerDescriptions: document.getElementById('powerDescriptions').value,
            powerDescriptions2: document.getElementById('powerDescriptions2').value,
            powerDescriptions3: document.getElementById('powerDescriptions3').value,
            details: {
                realName: document.getElementById('realName').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                gender: document.getElementById('gender').value,
                eyes: document.getElementById('eyes').value,
                hair: document.getElementById('hair').value,
                distinguishingFeatures: document.getElementById('distinguishingFeatures').value,
                background: {
                    origin: document.getElementById('origin').value,
                    occupation: document.getElementById('occupation').value
                },
                personality: "",
                team: document.getElementById('team').value,
                base: document.getElementById('base').value
            },
            notes: document.getElementById('notes').value,
            portrait: document.getElementById('portraitInput').value
        };

    // Save abilities
        ['melee', 'agility', 'resilience', 'vigilance', 'ego', 'logic'].forEach(ability => {
            characterData.abilities[ability] = {
                score: parseInt(document.getElementById(`${ability}Score`).value) || 0,
                defense: parseInt(document.getElementById(`${ability}Defense`).value) || 0,
                nonCombat: document.getElementById(`${ability}NonCombat`).value
            };
        });

    // Save damage
        ['melee', 'agility', 'ego', 'logic'].forEach(damageType => {
            characterData.damage[damageType] = {
                multiplier: parseInt(document.getElementById(`${damageType}DamageMultiplier`).value) || 0,
                ability: parseInt(document.getElementById(`${damageType}DamageAbility`).value) || 0
            };
        });

    // Save traits
        characterData.traits = [];
        const traitRows = document.getElementById('traitsTable').getElementsByTagName('tr');
    for (let i = 1; i < traitRows.length; i++) { // Start at 1 to skip header
        const inputs = traitRows[i].getElementsByTagName('input');
        if (inputs[0].value) {
            characterData.traits.push({
                name: inputs[0].value,
                description: inputs[1].value
            });
        }
    }

    // Save powers
    const powerRows = document.getElementById('powersTable').getElementsByTagName('tr');
    for (let i = 1; i < powerRows.length; i++) { // Start at 1 to skip header
        const inputs = powerRows[i].getElementsByTagName('input');
        if (inputs[0].value) {
            characterData.powers.push({
                name: inputs[0].value,
                set: inputs[1].value,
                cost: inputs[2].value,
                duration: inputs[3].value,
                action: inputs[4].value
            });
        }
    }

    // Save team maneuvers
    characterData.teamManeuvers = ['offensive', 'defensive', 'rally'].reduce((acc, type) => {
        acc[type] = {
            selected: document.querySelector(`input[name="teamManeuver"][value="${type}"]`).checked,
            level: document.querySelector(`input[name="${type}Level"]`).value,
            cost: document.querySelector(`input[name="${type}Cost"]`).value
        };
        return acc;
    }, {});

    // Create a Blob with the character data
    const blob = new Blob([JSON.stringify(characterData, null, 2)], {type: 'application/json'});

    // Create a download link
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = `${characterData.name || 'character'}.json`;

    // Append the link to the body, click it, and remove it
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);

    alert('Character file ready for download!');
}
function loadCharacter(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const characterData = JSON.parse(e.target.result);
                
                // Load basic character information
                document.getElementById('characterName').value = characterData.name || '';
                document.getElementById('rank').value = characterData.rank || '';
                document.getElementById('karma').value = characterData.karma || '';
                document.getElementById('health').value = characterData.health || '';
                document.getElementById('focus').value = characterData.focus || '';
                document.getElementById('initiativeModifier').value = characterData.initiative || '';
                document.getElementById('size').value = characterData.size || '';

                // Load speed
                if (characterData.speed) {
                    document.getElementById('run').value = characterData.speed.run || '';
                    document.getElementById('climb').value = characterData.speed.climb || '';
                    document.getElementById('swim').value = characterData.speed.swim || '';
                    document.getElementById('jump').value = characterData.speed.jump || '';
                }

                // Load abilities
                if (characterData.abilities) {
                    Object.entries(characterData.abilities).forEach(([ability, data]) => {
                        document.getElementById(`${ability}Score`).value = data.score || '';
                        document.getElementById(`${ability}Defense`).value = data.defense || '';
                        document.getElementById(`${ability}NonCombat`).value = data.nonCombat || '';
                    });
                }

                // Load damage
                if (characterData.damage) {
                    Object.entries(characterData.damage).forEach(([damageType, data]) => {
                        document.getElementById(`${damageType}DamageMultiplier`).value = data.multiplier || '';
                        document.getElementById(`${damageType}DamageAbility`).value = data.ability || '';
                    });
                }

                // Load traits
                if (characterData.traits) {
                    const traitRows = document.getElementById('traitsTable').getElementsByTagName('tr');
                    characterData.traits.forEach((trait, index) => {
                if (traitRows[index + 1]) { // +1 to skip the header row
                const inputs = traitRows[index + 1].getElementsByTagName('input');
                inputs[0].value = trait.name || '';
                inputs[1].value = trait.description || '';
            }
        });
                }

                // Load tags
                if (characterData.tags) {
                    document.getElementById('tags').value = characterData.tags.join(', ');
                }

                // Load powers
                if (characterData.powers) {
                    const powerRows = document.querySelectorAll('.powers-table tbody tr');
                    characterData.powers.forEach((power, index) => {
                        if (powerRows[index]) {
                            const inputs = powerRows[index].querySelectorAll('input');
                            inputs[0].value = power.name || '';
                            inputs[1].value = power.set || '';
                            inputs[2].value = power.cost || '';
                            inputs[3].value = power.duration || '';
                            inputs[4].value = power.action || '';
                        }
                    });
                }

                // Load power descriptions
                if (characterData.powerDescriptions) {
                    document.getElementById('powerDescriptions').value = characterData.powerDescriptions;
                }
                if (characterData.powerDescriptions2) {
                    document.getElementById('powerDescriptions2').value = characterData.powerDescriptions2;
                }
                if (characterData.powerDescriptions3) {
                    document.getElementById('powerDescriptions3').value = characterData.powerDescriptions3;
                }

                // Load team maneuvers
                if (characterData.teamManeuvers) {
                    ['offensive', 'defensive', 'rally'].forEach(type => {
                        document.querySelector(`input[name="teamManeuver"][value="${type}"]`).checked = characterData.teamManeuvers[type].selected;
                        document.querySelector(`input[name="${type}Level"]`).value = characterData.teamManeuvers[type].level;
                        document.querySelector(`input[name="${type}Cost"]`).value = characterData.teamManeuvers[type].cost;
                    });
                }

                // Load character details
                if (characterData.details) {
                    const details = characterData.details;
                    document.getElementById('realName').value = details.realName || '';
                    document.getElementById('height').value = details.height || '';
                    document.getElementById('weight').value = details.weight || '';
                    document.getElementById('gender').value = details.gender || '';
                    document.getElementById('eyes').value = details.eyes || '';
                    document.getElementById('hair').value = details.hair || '';
                    document.getElementById('distinguishingFeatures').value = details.distinguishingFeatures || '';
                    document.getElementById('team').value = details.team || '';
                    document.getElementById('base').value = details.base || '';
                    if (details.background) {
                        document.getElementById('origin').value = details.background.origin || '';
                        document.getElementById('occupation').value = details.background.occupation || '';
                    }
                }

                // Load notes
                document.querySelector('textarea[style="height: 60mm;"]').value = characterData.notes || '';

                // Load portrait
                if (characterData.portrait) {
                    document.getElementById('portraitInput').value = characterData.portrait;
                    loadPortrait(); // Call this function directly
                }

                // Update calculated fields
                updateCalculatedFields();

                console.log('Character loaded successfully:', characterData);
            } catch (error) {
                console.error('Error loading character:', error);
                alert('Error loading character file. Please make sure it\'s a valid JSON file.');
            }
        };
        reader.readAsText(file);
    }
}

    // Function to create a new character (reset all fields)
function newCharacter() {
    if (confirm('Are you sure you want to create a new character? This will erase the current character.')) {
        document.querySelectorAll('input, textarea').forEach(input => {
            input.value = '';
        });

            // Reset fields
        document.getElementById('portraitInput').value = '';
        document.getElementById('portraitDisplay').innerHTML = '';
        updateCalculatedFields();
    }
}
});
</script>

<!-- Dice Roller -->
<script>

    let lastRollResult = null;
    let lastRollType = null;

    document.addEventListener('DOMContentLoaded', function() {

        function handleManualEdit(event) {
            const field = event.target;
            if (field.classList.contains('calculated')) {
                field.classList.add('manually-edited');
            }
        }

        function handleRoll(event) {
            const ability = event.target.dataset.ability;
            const isAbilityCheck = event.target.classList.contains('roll-ability-check');
            const rollResult = rollDice();
            const abilityScore = parseInt(document.getElementById(`${ability}Score`).value) || 0;
            const damageMultiplier = isAbilityCheck ? 1 : (parseInt(document.getElementById(`${ability}DamageMultiplier`).value) || 1);

            lastRollResult = { rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability };
            lastRollType = isAbilityCheck ? 'ability' : 'combat';

            displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability);
            updateDiceDisplay(rollResult);
        }

        document.querySelectorAll('.roll-ability-check, .roll-combat-check').forEach(button => {
            button.addEventListener('click', handleRoll);
        });

        const rollAllButton = document.getElementById('rollAllButton');
        if (rollAllButton) {
            rollAllButton.addEventListener('click', rollAllDice);
        }
    });

        // Global functions
    function rollDice() {
        return {
            d6_1: Math.floor(Math.random() * 6) + 1,
            marvel: Math.floor(Math.random() * 6) + 1,
            d6_2: Math.floor(Math.random() * 6) + 1
        };
    }

    function displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability) {
        const { d6_1, marvel, d6_2 } = rollResult;
    const marvelValue = marvel === 1 ? 6 : marvel; // Treat 1 as 6 on the Marvel die
    const diceTotal = d6_1 + marvelValue + d6_2;
    const total = diceTotal + abilityScore;
    
    const resultElement = document.getElementById('rollResult');
    
    // Helper function to create colored spans
    const colorSpan = (value, color) => `<span style="background-color: ${color}; color: ${color === 'white' ? 'black' : 'white'}; padding: 0 3px;">${value}</span>`;
    
    const diceDisplay = `${colorSpan(d6_1, 'white')} + ${colorSpan(marvel, 'red')} + ${colorSpan(d6_2, 'white')}`;
    
    if (isAbilityCheck) {
        resultElement.innerHTML = `${ability.charAt(0).toUpperCase() + ability.slice(1)} Check: (${diceDisplay}) + ${abilityScore} = <strong>${total}</strong>`;
    } else {
        const damage = (marvelValue * damageMultiplier) + abilityScore;
        resultElement.innerHTML = `${ability.charAt(0).toUpperCase() + ability.slice(1)} Check: (${diceDisplay}) + ${abilityScore} = <strong>${total}</strong>. Damage: (${colorSpan(marvelValue, 'red')} * ${damageMultiplier}) + ${abilityScore} = <strong>${damage}</strong>`;
    }

    // Check for Ultimate Fantastic
    if (d6_1 === 6 && marvel === 1 && d6_2 === 6) {
        document.getElementById('ultimateFantasticIndicator').style.display = 'block';
        document.getElementById('fantasticIndicator').style.display = 'none';
    } else {
        document.getElementById('ultimateFantasticIndicator').style.display = 'none';
        document.getElementById('fantasticIndicator').style.display = marvel === 1 ? 'block' : 'none';
    }
}

function updateDiceDisplay(rollResult) {
    const { d6_1, marvel, d6_2 } = rollResult;
    animateDice('die1', d6_1);
    animateDice('die2', marvel);
    animateDice('die3', d6_2);

    for (let i = 1; i <= 3; i++) {
        document.getElementById(`rerollIndicator${i}`).textContent = '';
        document.getElementById(`die${i}reroll`).style.visibility = 'hidden';
    }
}

function animateDice(dieId, value) {
    const die = document.getElementById(dieId);
    die.classList.add('rolling');
    setTimeout(() => {
        die.textContent = value;
        die.classList.remove('rolling');
    }, 500);
}

function rollAllDice() {
    const rollResult = rollDice();
    lastRollResult = { rollResult, abilityScore: 0, damageMultiplier: 1, isAbilityCheck: true, ability: '' };
    lastRollType = 'ability';
    displayResult(rollResult, 0, 1, true, '');
    updateDiceDisplay(rollResult);
}

function rollEdge(dieNumber) {
    if (!lastRollResult) return;

    const { rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability } = lastRollResult;
    const newRoll = Math.floor(Math.random() * 6) + 1;
    const dieKey = dieNumber === 2 ? 'marvel' : (dieNumber === 1 ? 'd6_1' : 'd6_2');

    const rerollDie = document.getElementById(`die${dieNumber}reroll`);
    animateDice(`die${dieNumber}reroll`, newRoll);
    rerollDie.style.visibility = 'visible';

    const indicator = document.getElementById(`rerollIndicator${dieNumber}`);
    indicator.textContent = 'Edge';
    indicator.className = 'reroll-indicator edge-indicator';

    if (dieKey === 'marvel') {
            // For Marvel die, 1 is treated as 6 for comparison
        const currentValue = rollResult[dieKey] === 1 ? 6 : rollResult[dieKey];
        const newValue = newRoll === 1 ? 6 : newRoll;
        if (newValue >= currentValue) {
            rollResult[dieKey] = newRoll;
        }
    } else {
        if (newRoll > rollResult[dieKey]) {
            rollResult[dieKey] = newRoll;
        }
    }

    displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability);
}

function rollTrouble(dieNumber) {
    if (!lastRollResult) return;

    const { rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability } = lastRollResult;
    const newRoll = Math.floor(Math.random() * 6) + 1;
    const dieKey = dieNumber === 2 ? 'marvel' : (dieNumber === 1 ? 'd6_1' : 'd6_2');

    const rerollDie = document.getElementById(`die${dieNumber}reroll`);
    animateDice(`die${dieNumber}reroll`, newRoll);
    rerollDie.style.visibility = 'visible';

    const indicator = document.getElementById(`rerollIndicator${dieNumber}`);
    indicator.textContent = 'Trouble';
    indicator.className = 'reroll-indicator trouble-indicator';

    if (dieKey === 'marvel') {
            // For Marvel die, 1 is treated as 6 for comparison
        const currentValue = rollResult[dieKey] === 1 ? 6 : rollResult[dieKey];
        const newValue = newRoll === 1 ? 6 : newRoll;
        if (newValue < currentValue) {
            rollResult[dieKey] = newRoll;
        }
    } else {
        if (newRoll < rollResult[dieKey]) {
            rollResult[dieKey] = newRoll;
        }
    }

    displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability);
}

        // Make sure these functions are accessible globally
window.rollEdge = rollEdge;
window.rollTrouble = rollTrouble;
</script>

<!-- Character Sheet Calculations -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rank = document.getElementById('rank');
        const size = document.getElementById('size');
        const abilityScores = ['melee', 'agility', 'resilience', 'vigilance', 'ego', 'logic'].map(ability => document.getElementById(`${ability}Score`));

    // Define updateCalculatedFields at the top
        function updateCalculatedFields() {
            ['melee', 'agility', 'resilience', 'vigilance', 'ego', 'logic'].forEach(calculateAbilityFields);
            calculateKarma();
            calculateHealth();
            calculateFocus();
            calculateMovementSpeeds();
            calculateInitiativeModifier();
            calculateDamage();
        }

    // Make updateCalculatedFields globally accessible
        window.updateCalculatedFields = updateCalculatedFields;

        function handleManualEdit(event) {
            const field = event.target;
            if (field.classList.contains('calculated')) {
                field.classList.add('manually-edited');
            }
        }

        function updateField(id, value) {
            const field = document.getElementById(id);
            if (field && !field.classList.contains('manually-edited')) {
                field.value = value;
            }
        }

        function calculateKarma() {
            updateField('karma', rank.value);
        }

        function calculateAbilityFields(ability) {
            const score = parseInt(document.getElementById(`${ability}Score`).value) || 0;
            updateField(`${ability}Defense`, score + 10);
            const nonCombatValue = score > 0 ? `+${score}` : score.toString();
            updateField(`${ability}NonCombat`, nonCombatValue);
        }

        function calculateHealth() {
            const resilience = parseInt(document.getElementById('resilienceScore').value) || 0;
            updateField('health', resilience < 1 ? 10 : resilience * 30);
        }

        function calculateFocus() {
            const vigilance = parseInt(document.getElementById('vigilanceScore').value) || 0;
            updateField('focus', vigilance < 1 ? 10 : vigilance * 30);
        }

        function calculateMovementSpeeds() {
            const agility = parseInt(document.getElementById('agilityScore').value) || 0;
            const sizeValue = size.value;
            let sizeModifier = 0;
            if (sizeValue === 'Big') sizeModifier = 1;
            if (sizeValue === 'Small') sizeModifier = -1;

            const baseSpeed = 5 + Math.floor(agility / 5) + sizeModifier;
            updateField('run', baseSpeed);
            updateField('climb', Math.max(1, Math.floor(baseSpeed / 2)));
            updateField('swim', Math.max(1, Math.floor(baseSpeed / 2)));
            updateField('jump', Math.max(1, Math.floor(baseSpeed / 2)));
        }

        function calculateInitiativeModifier() {
            const vigilance = parseInt(document.getElementById('vigilanceScore').value) || 0;
            const modifierValue = vigilance >= 0 ? `+${vigilance}` : vigilance.toString();
            updateField('initiativeModifier', modifierValue);
        }

        function calculateDamage() {
            const rankValue = parseInt(rank.value) || 1;
            ['melee', 'agility', 'ego', 'logic'].forEach(ability => {
                const score = parseInt(document.getElementById(`${ability}Score`).value) || 0;
                updateField(`${ability}DamageMultiplier`, rankValue);
                updateField(`${ability}DamageAbility`, score);
            });
        }

        rank.addEventListener('input', () => {
            calculateKarma();
            calculateDamage();
            updateCalculatedFields();
        });

        size.addEventListener('change', () => {
            calculateMovementSpeeds();
            updateCalculatedFields();
        });

        abilityScores.forEach(abilityScore => {
            abilityScore.addEventListener('input', () => {
                const ability = abilityScore.id.replace('Score', '');
                calculateAbilityFields(ability);
                if (ability === 'resilience') calculateHealth();
                if (ability === 'vigilance') {
                    calculateFocus();
                    calculateInitiativeModifier();
                }
                if (ability === 'agility') calculateMovementSpeeds();
                calculateDamage();
            });
        });

        document.querySelectorAll('.calculated').forEach(field => {
            field.addEventListener('input', handleManualEdit);
        });

    // Initial calculations
        updateCalculatedFields();
    });
</script>

<!-- Character Sheet Portrait -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const portraitInput = document.getElementById('portraitInput');
        const portraitDisplay = document.getElementById('portraitDisplay');

        portraitInput.addEventListener('input', debounce(loadPortrait, 300));

        function loadPortrait() {
            const input = portraitInput.value.trim();
            if (!input) {
                portraitDisplay.innerHTML = '';
                return;
            }

            let imageSrc;
            if (input.startsWith('http://') || input.startsWith('https://')) {
            // It's a URL
                imageSrc = input;
            } else {
            // It's a filename, assume it's in the 'portrait' directory
                imageSrc = `${input}`;
            }

        // Create and set up the image
            const img = document.createElement('img');
            img.onload = function() {
            // Clear previous content and append the new image
                portraitDisplay.innerHTML = '';
                portraitDisplay.appendChild(img);
            };
            img.onerror = function() {
                portraitDisplay.innerHTML = 'Failed to load image. Please check the URL or filename.';
            };
            img.src = imageSrc;
            img.alt = 'Character Portrait';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
        }

    // Debounce function to limit how often loadPortrait is called
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        window.loadPortrait = loadPortrait
    });
</script>

</body>
</html>
