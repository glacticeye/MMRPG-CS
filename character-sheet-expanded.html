<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel Multiverse RPG Character Sheet</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="page">
        <div class="header">
            <h1>Marvel Multiverse Character Sheet</h1>
        </div>

        <table>
            <tr>
                <th>Name</th>
                <th>Rank</th>
                <th>Karma</th>
            </tr>
            <tr>
                <td><input type="text" id="characterName" placeholder="Codename"></td>
                <td><input type="number" id="rank" placeholder="Rank" min="1" max="6" value="1"></td>
                <td><input type="number" id="karma" placeholder="Karma (Rank)" class="calculated"></td>
            </tr>
        </table>

        <div class="two-column">
            <div>
                <table>
                    <tr>
                        <th>Health (Resilience x 30)</th>
                        <td><input type="number" id="health" class="calculated"></td>
                    </tr>
                </table>
            </div>
            <div>
                <table>
                    <tr>
                        <th>Focus (Vigilance x 30)</th>
                        <td><input type="number" id="focus" class="calculated"></td>
                    </tr>
                </table>
            </div>
        </div>

        <table>
            <tr>
                <th>Run</th>
                <th>Climb</th>
                <th>Swim</th>
                <th>Jump</th>
                <th>Initiative Modifier</th>
            </tr>
            <tr>
                <td><input type="number" id="run" class="calculated"></td>
                <td><input type="number" id="climb" class="calculated"></td>
                <td><input type="number" id="swim" class="calculated"></td>
                <td><input type="number" id="jump" class="calculated"></td>
                <td><input type="text" id="initiativeModifier" class="calculated"></td>
            </tr>
        </table>

        <div class="section-title">Abilities</div>
        <table>
            <tr><th>Ability</th><th>Score</th><th>Defense</th><th>Non-Combat Checks</th></tr>
            <tr>
                <td>Melee</td>
                <td><input type="number" id="meleeScore" min="-3" max="9" value="0"></td>
                <td><input type="number" id="meleeDefense" class="calculated"></td>
                <td><input type="text" id="meleeNonCombat" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="melee">Roll</button></td>
            </tr>
                <td>Agility</td>
                <td><input type="number" id="agilityScore" min="-3" max="9" value="0"></td>
                <td><input type="number" id="agilityDefense" class="calculated"></td>
                <td><input type="text" id="agilityNonCombat" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="agility">Roll</button></td>
            <tr>
                <td>Resilience</td>
                <td><input type="number" id="resilienceScore" min="-3" max="9" value="0"></td>
                <td><input type="number" id="resilienceDefense" class="calculated"></td>
                <td><input type="text" id="resilienceNonCombat" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="resilience">Roll</button></td>
            <tr>
                <td>Vigilance</td>
                <td><input type="number" id="vigilanceScore" min="-3" max="9" value="0"></td>
                <td><input type="number" id="vigilanceDefense" class="calculated"></td>
                <td><input type="text" id="vigilanceNonCombat" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="vigilance">Roll</button></td>
            <tr>
                <td>Ego</td>
                <td><input type="number" id="egoScore" min="-3" max="9" value="0"></td>
                <td><input type="number" id="egoDefense" class="calculated"></td>
                <td><input type="text" id="egoNonCombat" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="ego">Roll</button></td>
            <tr>
                <td>Logic</td>
                <td><input type="number" id="logicScore" min="-3" max="9" value="0"></td>
                <td><input type="number" id="logicDefense" class="calculated"></td>
                <td><input type="text" id="logicNonCombat" class="calculated"></td>
                <td><button class="roll-ability-check" data-ability="logic">Roll</button></td>
            </tr>
        </table>

        <div class="section-title">Damage</div>
        <table>
            <tr><th>Damage</th><th>Multiplier</th><th></th><th>Ability</th></tr>
            <tr>
                <td>Melee</td>
                <td><input type="number" id="meleeDamageMultiplier" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="meleeDamageAbility" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="melee">Roll</button></td>              
            <tr>
                <td>Agility</td>
                <td><input type="number" id="agilityDamageMultiplier" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="agilityDamageAbility" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="agility">Roll</button></td>
            <tr>
                <td>Ego</td>
                <td><input type="number" id="egoDamageMultiplier" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="egoDamageAbility" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="ego">Roll</button></td>
            <tr>
                <td>Logic</td>
                <td><input type="number" id="logicDamageMultiplier" class="calculated"></td>
                <td>+</td>
                <td><input type="number" id="logicDamageAbility" class="calculated"></td>
                <td><button class="roll-combat-check" data-ability="logic">Roll</button></td>
        </table>
    </div>

	<div class="page">

        <div class="section-title">Traits</div>
        <table>
            <tr><th>Trait</th><th>Description</th></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
			<tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td></tr>
        </table>
		
		<div class="section-title">Tags</div>
		<textarea id="tags" placeholder="Enter tags here"></textarea>
		</div>
		<div class="page">
		
        <div class="section-title">Powers</div>
        <table>
            <tr><th>Power</th><th>Set</th><th>Cost</th><th>Duration</th><th>Action</th></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
			<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
			<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
			<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
        </table>
		</div>
	</div>
	<div class="page">

        <div class="section-title">Team Maneuver</div>
        <table>
            <tr><th>Type</th><th>Selected</th><th>Level</th><th>Cost</th></tr>
            <tr><td>Offensive</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td></tr>
            <tr><td>Defensive</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td></tr>
            <tr><td>Rally</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td></tr>
        </table>

        <div class="section-title">Character Details</div>
        <table>
            <tr>
                <th>Real Name</th>
                <td><input type="text"></td>
                <th>Height</th>
                <td><input type="text"></td>
            </tr>
            <tr>
                <th>Weight</th>
                <td><input type="text"></td>
                <th>Gender</th>
                <td><input type="text"></td>
            </tr>
            <tr>
                <th>Eyes</th>
                <td><input type="text"></td>
                <th>Hair</th>
                <td><input type="text"></td>
            </tr>
            <tr>
                <th>Size</th>
                <td><input type="text"></td>
                <th>Origin</th>
                <td><input type="text"></td>
            </tr>
            <tr>
                <th>Distinguishing Features</th>
                <td colspan="3"><input type="text"></td>
            </tr>
            <tr>
                <th>Team</th>
                <td><input type="text"></td>
                <th>Base</th>
                <td><input type="text"></td>
            </tr>
            <tr>
                <th>Occupation</th>
                <td colspan="3"><input type="text"></td>
            </tr>
        </table>

            <div class="section-title">Speed</div>
        <table>
            <tr>
                <th>Size</th>
                <td>
                    <select id="size">
                        <option value="Average">Average</option>
                        <option value="Big">Big</option>
                        <option value="Small">Small</option>
                    </select>
                </td>
                <th>Run Speed</th>
                <td><span id="run-speed"></span> spaces per round</td>
            </tr>
        </table>

		</div>
		</div>
		<div class="page">

        <div class="section-title">Notes</div>
        <textarea style="height: 100px;"></textarea>

    <div class="dice-roller">
        <div id="diceContainer" class="dice-container">
            <div class="die-group">
                <div class="die-pair">
                    <div class="die-column">
                        <div id="die1" class="die die-white">1</div>
                    </div>
                    <div class="die-column">
                        <div id="rerollIndicator1" class="reroll-indicator"></div>
                        <div id="die1reroll" class="die die-white" style="visibility: hidden;">1</div>
                    </div>
                </div>
                <div class="edge-trouble-buttons">
                    <button class="edge-button" onclick="rollEdge(1)">Edge</button>
                    <button class="trouble-button" onclick="rollTrouble(1)">Trouble</button>
                </div>
            </div>
            <div class="die-group">
                <div class="fantastic-indicator" id="fantasticIndicator">Fantastic!</div>
                <div class="die-pair">
                    <div class="die-column">
                        <div id="die2" class="die die-red">1</div>
                    </div>
                    <div class="die-column">
                        <div id="rerollIndicator2" class="reroll-indicator"></div>
                        <div id="die2reroll" class="die die-red" style="visibility: hidden;">1</div>
                    </div>
                </div>
                <div class="edge-trouble-buttons">
                    <button class="edge-button" onclick="rollEdge(2)">Edge</button>
                    <button class="trouble-button" onclick="rollTrouble(2)">Trouble</button>
                </div>
            </div>
            <div class="die-group">
                <div class="die-pair">
                    <div class="die-column">
                        <div id="die3" class="die die-white">1</div>
                    </div>
                    <div class="die-column">
                        <div id="rerollIndicator3" class="reroll-indicator"></div>
                        <div id="die3reroll" class="die die-white" style="visibility: hidden;">1</div>
                    </div>
                </div>
                <div class="edge-trouble-buttons">
                    <button class="edge-button" onclick="rollEdge(3)">Edge</button>
                    <button class="trouble-button" onclick="rollTrouble(3)">Trouble</button>
                </div>
            </div>
        </div>
        <button id="rollAllButton">Roll All Dice</button>
        <div id="rollResult"></div>
    </div>

    <script>
                    // Global variables
        let lastRollResult = null;
        let lastRollType = null;

        document.addEventListener('DOMContentLoaded', function() {
            const rank = document.getElementById('rank');
            const size = document.getElementById('size');
            const abilities = ['melee', 'agility', 'resilience', 'vigilance', 'ego', 'logic'];

            function updateField(id, value) {
                const field = document.getElementById(id);
                if (field && !field.classList.contains('manually-edited')) {
                    field.value = value;
                }
            }

            function calculateAbilityFields() {
                abilities.forEach(ability => {
                    const score = parseInt(document.getElementById(`${ability}Score`).value) || 0;
                    updateField(`${ability}Defense`, score + 10);
                    updateField(`${ability}NonCombat`, `+${score}`);
                });
            }

            function calculateHealth() {
                const resilience = parseInt(document.getElementById('resilienceScore').value) || 0;
                updateField('health', resilience < 1 ? 10 : resilience * 30);
            }

            function calculateFocus() {
                const vigilance = parseInt(document.getElementById('vigilanceScore').value) || 0;
                updateField('focus', vigilance < 1 ? 10 : vigilance * 30);
            }

            function calculateMovementSpeeds() {
                const agility = parseInt(document.getElementById('agilityScore').value) || 0;
                const sizeValue = size.value;
                let sizeModifier = 0;
                if (sizeValue === 'Big') sizeModifier = 1;
                if (sizeValue === 'Small') sizeModifier = -1;
                
                const baseSpeed = 5 + Math.floor(agility / 5) + sizeModifier;
                updateField('run', baseSpeed);
                updateField('climb', Math.max(1, Math.floor(baseSpeed / 2)));
                updateField('swim', Math.max(1, Math.floor(baseSpeed / 2)));
                updateField('jump', Math.max(1, Math.floor(baseSpeed / 2)));
                
                document.getElementById('run-speed').textContent = baseSpeed;
            }

            function calculateInitiativeModifier() {
                const vigilance = parseInt(document.getElementById('vigilanceScore').value) || 0;
                updateField('initiativeModifier', `+${vigilance}`);
            }

            function calculateDamage() {
                const rankValue = parseInt(rank.value) || 0;
                ['melee', 'agility', 'ego', 'logic'].forEach(ability => {
                    const score = parseInt(document.getElementById(`${ability}Score`).value) || 0;
                    updateField(`${ability}DamageMultiplier`, rankValue);
                    updateField(`${ability}DamageAbility`, score);
                });
            }

            function updateCalculatedFields() {
                calculateAbilityFields();
                calculateHealth();
                calculateFocus();
                calculateMovementSpeeds();
                calculateInitiativeModifier();
                calculateDamage();
            }

            function handleManualEdit(event) {
                const field = event.target;
                if (field.classList.contains('calculated')) {
                    field.classList.add('manually-edited');
                }
            }

            function handleRoll(event) {
                const ability = event.target.dataset.ability;
                const isAbilityCheck = event.target.classList.contains('roll-ability-check');
                const rollResult = rollDice();
                const abilityScore = parseInt(document.getElementById(`${ability}Score`).value) || 0;
                const damageMultiplier = isAbilityCheck ? 1 : (parseInt(document.getElementById(`${ability}DamageMultiplier`).value) || 1);

                lastRollResult = { rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability };
                lastRollType = isAbilityCheck ? 'ability' : 'combat';

                displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability);
                updateDiceDisplay(rollResult);
            }

            // Event Listeners
            if (rank) rank.addEventListener('input', updateCalculatedFields);
            if (size) size.addEventListener('change', calculateMovementSpeeds);

            abilities.forEach(ability => {
                const scoreInput = document.getElementById(`${ability}Score`);
                if (scoreInput) {
                    scoreInput.addEventListener('input', updateCalculatedFields);
                }
            });

            document.querySelectorAll('.calculated').forEach(field => {
                field.addEventListener('input', handleManualEdit);
            });

            document.querySelectorAll('.roll-ability-check, .roll-combat-check').forEach(button => {
                button.addEventListener('click', handleRoll);
            });

            const rollAllButton = document.getElementById('rollAllButton');
            if (rollAllButton) {
                rollAllButton.addEventListener('click', rollAllDice);
            }

            // Initialize calculations
            updateCalculatedFields();
        });

        // Global functions
        function rollDice() {
            return {
                d6_1: Math.floor(Math.random() * 6) + 1,
                marvel: Math.floor(Math.random() * 6) + 1,
                d6_2: Math.floor(Math.random() * 6) + 1
            };
        }

        function displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability) {
        const { d6_1, marvel, d6_2 } = rollResult;
        const marvelValue = marvel === 1 ? 6 : marvel; // Treat 1 as 6 on the Marvel die
        const diceTotal = d6_1 + marvelValue + d6_2;
        const total = diceTotal + abilityScore;
        
        const resultElement = document.getElementById('rollResult');
        
        if (isAbilityCheck) {
            resultElement.textContent = `${ability.charAt(0).toUpperCase() + ability.slice(1)} Check: Total: ${diceTotal} + ${abilityScore} = ${total}`;
        } else {
            const damage = (marvelValue * damageMultiplier) + abilityScore; // Use marvelValue for damage calculation
            resultElement.textContent = `${ability.charAt(0).toUpperCase() + ability.slice(1)} Damage: Total: ${diceTotal} + ${abilityScore} = ${total}. Damage: (${marvelValue} * ${damageMultiplier}) + ${abilityScore} = ${damage}`;
        }

        document.getElementById('fantasticIndicator').style.display = marvel === 1 ? 'block' : 'none';
    }

        function updateDiceDisplay(rollResult) {
            const { d6_1, marvel, d6_2 } = rollResult;
            animateDice('die1', d6_1);
            animateDice('die2', marvel);
            animateDice('die3', d6_2);

            for (let i = 1; i <= 3; i++) {
                document.getElementById(`rerollIndicator${i}`).textContent = '';
                document.getElementById(`die${i}reroll`).style.visibility = 'hidden';
            }
        }

        function animateDice(dieId, value) {
            const die = document.getElementById(dieId);
            die.classList.add('rolling');
            setTimeout(() => {
                die.textContent = value;
                die.classList.remove('rolling');
            }, 500);
        }

        function rollAllDice() {
            const rollResult = rollDice();
            lastRollResult = { rollResult, abilityScore: 0, damageMultiplier: 1, isAbilityCheck: true, ability: 'All Dice' };
            lastRollType = 'ability';
            displayResult(rollResult, 0, 1, true, 'All Dice');
            updateDiceDisplay(rollResult);
        }

        function rollEdge(dieNumber) {
            if (!lastRollResult) return;

            const { rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability } = lastRollResult;
            const newRoll = Math.floor(Math.random() * 6) + 1;
            const dieKey = dieNumber === 2 ? 'marvel' : (dieNumber === 1 ? 'd6_1' : 'd6_2');

            const rerollDie = document.getElementById(`die${dieNumber}reroll`);
            animateDice(`die${dieNumber}reroll`, newRoll);
            rerollDie.style.visibility = 'visible';

            const indicator = document.getElementById(`rerollIndicator${dieNumber}`);
            indicator.textContent = 'Edge';
            indicator.className = 'reroll-indicator edge-indicator';

            if (dieKey === 'marvel') {
                if (newRoll === 1 || newRoll > rollResult[dieKey]) {
                    rollResult[dieKey] = newRoll;
                }
            } else {
                if (newRoll > rollResult[dieKey]) {
                    rollResult[dieKey] = newRoll;
                }
            }

            displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability);
        }

        function rollTrouble(dieNumber) {
            if (!lastRollResult) return;

            const { rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability } = lastRollResult;
            const newRoll = Math.floor(Math.random() * 6) + 1;
            const dieKey = dieNumber === 2 ? 'marvel' : (dieNumber === 1 ? 'd6_1' : 'd6_2');

            const rerollDie = document.getElementById(`die${dieNumber}reroll`);
            animateDice(`die${dieNumber}reroll`, newRoll);
            rerollDie.style.visibility = 'visible';

            const indicator = document.getElementById(`rerollIndicator${dieNumber}`);
            indicator.textContent = 'Trouble';
            indicator.className = 'reroll-indicator trouble-indicator';

            if (dieKey === 'marvel') {
                if (newRoll > 1 && newRoll < rollResult[dieKey]) {
                    rollResult[dieKey] = newRoll;
                }
            } else {
                if (newRoll < rollResult[dieKey]) {
                    rollResult[dieKey] = newRoll;
                }
            }

            displayResult(rollResult, abilityScore, damageMultiplier, isAbilityCheck, ability);
        }

        // Make sure these functions are accessible globally
        window.rollEdge = rollEdge;
        window.rollTrouble = rollTrouble;
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const rank = document.getElementById('rank');
        const size = document.getElementById('size');
        const abilityScores = ['melee', 'agility', 'resilience', 'vigilance', 'ego', 'logic'].map(ability => document.getElementById(`${ability}Score`));

        function updateField(id, value) {
            const field = document.getElementById(id);
            if (!field.classList.contains('manually-edited')) {
                field.value = value;
            }
        }

        function calculateKarma() {
            updateField('karma', rank.value);
        }

        function calculateAbilityFields(ability) {
            const score = parseInt(document.getElementById(`${ability}Score`).value) || 0;
            updateField(`${ability}Defense`, score + 10);
            updateField(`${ability}NonCombat`, `+${score}`);
        }

        function calculateHealth() {
            const resilience = parseInt(document.getElementById('resilienceScore').value) || 0;
            updateField('health', resilience < 1 ? 10 : resilience * 30);
        }

        function calculateFocus() {
            const vigilance = parseInt(document.getElementById('vigilanceScore').value) || 0;
            updateField('focus', vigilance < 1 ? 10 : resilience * 30);
        }

        function calculateMovementSpeeds() {
            const agility = parseInt(document.getElementById('agilityScore').value) || 0;
            const sizeValue = size.value;
            let sizeModifier = 0;
            if (sizeValue === 'Big') sizeModifier = 1;
            if (sizeValue === 'Small') sizeModifier = -1;
            
            const baseSpeed = 5 + Math.floor(agility / 5) + sizeModifier;
            updateField('run', baseSpeed);
            updateField('climb', Math.max(1, Math.floor(baseSpeed / 2)));
            updateField('swim', Math.max(1, Math.floor(baseSpeed / 2)));
            updateField('jump', Math.max(1, Math.floor(baseSpeed / 2)));
            
            document.getElementById('run-speed').textContent = baseSpeed;
        }

        function calculateInitiativeModifier() {
            const vigilance = parseInt(document.getElementById('vigilanceScore').value) || 0;
            updateField('initiativeModifier', `+${vigilance}`);
        }

        function calculateDamage() {
            const rankValue = parseInt(rank.value) || 0;
            ['melee', 'agility', 'ego', 'logic'].forEach(ability => {
                const score = parseInt(document.getElementById(`${ability}Score`).value) || 0;
                updateField(`${ability}DamageMultiplier`, rankValue);
                updateField(`${ability}DamageAbility`, score);
            });
        }

        function handleManualEdit(event) {
            const field = event.target;
            if (field.classList.contains('calculated')) {
                field.classList.add('manually-edited');
            }
        }

        rank.addEventListener('input', () => {
            calculateKarma();
            calculateDamage();
        });
        
        size.addEventListener('change', calculateMovementSpeeds);

        abilityScores.forEach(abilityScore => {
            abilityScore.addEventListener('input', () => {
                const ability = abilityScore.id.replace('Score', '');
                calculateAbilityFields(ability);
                if (ability === 'resilience') calculateHealth();
                if (ability === 'vigilance') {
                    calculateFocus();
                    calculateInitiativeModifier();
                }
                if (ability === 'agility') calculateMovementSpeeds();
                calculateDamage();
            });
        });

        document.querySelectorAll('.calculated').forEach(field => {
            field.addEventListener('input', handleManualEdit);
        });

        // Initial calculations
        calculateKarma();
        abilityScores.forEach(abilityScore => {
            const ability = abilityScore.id.replace('Score', '');
            calculateAbilityFields(ability);
        });
        calculateHealth();
        calculateFocus();
        calculateMovementSpeeds();
        calculateInitiativeModifier();
        calculateDamage();
    });
</script>

</body>
</html>
